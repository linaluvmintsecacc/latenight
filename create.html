<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buat / Kemaskini Update</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Nunito', sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(-45deg, #d7f5d1, #a3d7a5, #d7f5d1, #a3d7a5);
      background-size: 400% 400%;
      animation: greenPulse 20s ease infinite;
      color: #2e4d2e;
    }
    @keyframes greenPulse {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    .container {
      background: linear-gradient(145deg, #f0fff0, #d8f5d8);
      border-radius: 25px;
      padding: 40px 50px;
      box-shadow:
        0 8px 24px rgba(27, 94, 32, 0.15),
        inset 0 0 8px rgba(255, 255, 255, 0.6);
      border: 1.5px solid #a3d4a5;
      max-width: 600px;
      width: 100%;
      box-sizing: border-box;
    }
    h1 {
      border-bottom: 2px solid #4caf50;
      padding-bottom: 10px;
      margin-bottom: 30px;
      font-weight: 700;
      text-align: center;
      color: #2e4d2e;
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
    }
    input[type="text"],
    textarea,
    input[type="file"] {
      width: 100%;
      padding: 14px 16px;
      border-radius: 14px;
      border: 1.8px solid #a3d4a5;
      font-size: 1rem;
      font-family: 'Nunito', sans-serif;
      color: #1e293b;
      margin-bottom: 18px;
    }
    textarea {
      min-height: 130px;
      resize: vertical;
    }
    button {
      background: #4caf50;
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      border: none;
      padding: 14px 0;
      width: 100%;
      border-radius: 18px;
      cursor: pointer;
      margin-top: 15px;
    }
    button:hover {
      background: #388e3c;
    }
    #back-button {
      background: transparent;
      color: #4caf50;
      border: 2px solid #4caf50;
      padding: 10px 25px;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 20px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="container">
    <button id="back-button">Kembali</button>
    <h1 id="page-title">Buat Update Baru</h1>
    <form id="updateForm">
      <label for="tajuk">Tajuk/Tarikh</label>
      <input id="tajuk" type="text" required placeholder="..." />

      <label for="isi">Isi</label>
      <textarea id="isi" required placeholder="..."></textarea>

      <label for="media">Upload Gambar/Video</label>
      <input id="media" type="file" accept="image/*,video/*" />

      <button type="submit">Hantar</button>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD5kksl475n1Blo9tjP9KVMSrebO8AFJxc",
      authDomain: "latenight-4c61a.firebaseapp.com",
      projectId: "latenight-4c61a",
      storageBucket: "latenight-4c61a.appspot.com",
      messagingSenderId: "208698993180",
      appId: "1:208698993180:web:7741767d129b4d43034dd9",
      measurementId: "G-MVKZ0R87Y3"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Supabase setup
    const supabaseUrl = "https://pbpqkpxbjxriujcaydgi.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBicHFrcHhianhyaXVqY2F5ZGdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDYwODksImV4cCI6MjA3NDcyMjA4OX0.yW1yOoBrgBGCTnZWjWIAZKIAKSngoRsELFZSaCLiQcM";
    const supabase = createClient(supabaseUrl, supabaseKey);

    const params = new URLSearchParams(window.location.search);
    const updateId = params.get("id");
    const isEdit = params.get("edit") === "true";

    const tajukInput = document.getElementById("tajuk");
    const isiInput = document.getElementById("isi");
    const mediaInput = document.getElementById("media");
    const form = document.getElementById("updateForm");
    const backBtn = document.getElementById("back-button");
    const pageTitle = document.getElementById("page-title");
    const submitBtn = form.querySelector("button[type='submit']");

    let oldMediaUrl = null;

    backBtn.onclick = () => { window.location.href = "index.html"; };

    // Load data kalau edit
    if (isEdit && updateId) {
      pageTitle.textContent = "Kemaskini Update";
      submitBtn.textContent = "Kemaskini";

      (async () => {
        const docRef = doc(db, "updates", updateId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          tajukInput.value = data.tajuk || "";
          isiInput.value = data.isi || "";
          oldMediaUrl = data.mediaUrl || null;
        }
      })();
    }

    // Upload fail ke Supabase
    async function uploadFile(file) {
      if (!file) return null;
      const filePath = `${Date.now()}_${file.name}`;
      const { error } = await supabase.storage.from("media").upload(filePath, file);
      if (error) {
        console.error("Upload error:", error);
        alert("Gagal upload fail: " + (error.message || "Unknown error"));
        return null;
      }
      return `${supabaseUrl}/storage/v1/object/public/media/${filePath}`;
    }

    // Padam media lama (Supabase)
    async function deleteOldMedia(url) {
      if (!url) return;
      const fileName = url.split("/").pop();
      const { error } = await supabase.storage.from("media").remove([fileName]);
      if (error) {
        console.error("Gagal delete media lama:", error);
      }
    }

    // Submit form
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const tajuk = tajukInput.value.trim();
      const isi = isiInput.value.trim();
      const file = mediaInput.files[0];

      if (!tajuk || !isi) {
        alert("Sila isi semua ruangan.");
        return;
      }

      // ✅ Check saiz fail ≤ 50MB
      if (file && file.size > 50 * 1024 * 1024) {
        alert("Fail terlalu besar! Maksimum 50MB sahaja.");
        return;
      }

      let mediaUrl = oldMediaUrl;
      if (file) {
        if (oldMediaUrl) await deleteOldMedia(oldMediaUrl); // padam lama
        mediaUrl = await uploadFile(file); // upload baru
      }

      try {
        if (isEdit && updateId) {
          const docRef = doc(db, "updates", updateId);
          await updateDoc(docRef, { tajuk, isi, mediaUrl, updatedAt: serverTimestamp() });
          alert("Update berjaya dikemaskini!");
        } else {
          await addDoc(collection(db, "updates"), { tajuk, isi, mediaUrl, createdAt: serverTimestamp() });
          alert("Update berjaya disimpan!");
        }
        window.location.href = "index.html";
      } catch (err) {
        console.error("Firestore error:", err);
        alert("Gagal simpan update.");
      }
    });
  </script>
</body>
</html>

